--liquibase formatted sql


--changeset root:schema.create.table.user_and_authorities author:nikita.biloshytskyi contexts: init

CREATE TABLE AUTHORITY (
   ID BIGINT GENERATED BY DEFAULT AS IDENTITY,
   NAME VARCHAR(255),
   PRIMARY KEY (ID)
);

ALTER TABLE AUTHORITY ADD CONSTRAINT AUTHORITY_NAME UNIQUE(NAME);

CREATE TABLE USER (
  ID BIGINT GENERATED BY DEFAULT AS IDENTITY,
  PASSWORD VARCHAR(255),
  USER_NAME VARCHAR(255),
  ACCOUNT_EXPIRED BOOLEAN,
  ACCOUNT_LOCKED BOOLEAN,
  CREDENTIALS_EXPIRED BOOLEAN,
  ENABLED BOOLEAN,
  PRIMARY KEY (ID)
);

ALTER TABLE USER ADD CONSTRAINT USER_USER_NAME UNIQUE(USER_NAME);

CREATE TABLE USERS_AUTHORITIES (
   USER_ID BIGINT NOT NULL,
   AUTHORITY_ID BIGINT NOT NULL,
   PRIMARY KEY (USER_ID, AUTHORITY_ID)
);

ALTER TABLE USERS_AUTHORITIES ADD CONSTRAINT USERS_AUTHORITIES_AUTHORITY
   FOREIGN KEY (AUTHORITY_ID) REFERENCES AUTHORITY;

ALTER TABLE USERS_AUTHORITIES ADD CONSTRAINT USERS_AUTHORITIES_USER
   FOREIGN KEY (USER_ID) REFERENCES USER;

CREATE TABLE `GAME_BOARD` (
  `ID`                  BIGINT          NOT NULL AUTO_INCREMENT,
  `VERSION`             INT             NOT NULL DEFAULT 0,
  `LAST_UPDATED`        TIMESTAMP       NOT NULL,
   PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;


CREATE TABLE `GAME_STATE` (
  `ID`                          BIGINT          NOT NULL AUTO_INCREMENT,
  `VERSION`                     INT             NOT NULL DEFAULT 0,
  `LAST_UPDATED`                TIMESTAMP       NOT NULL,
  `COMPLETE`                    BOOLEAN,
  `STARTED`                     BOOLEAN,
  `ACTIVE_PLAYER_ENTITY_ID`     BIGINT          NOT NULL,
  `GAME_BOARD_ID`               BIGINT          NOT NULL,
   PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `PIT` (
  `ID`                          BIGINT          NOT NULL AUTO_INCREMENT,
  `VERSION`                     INT             NOT NULL DEFAULT 0,
  `LAST_UPDATED`                TIMESTAMP       NOT NULL,
  `INDEX`                       INT,
  `IS_KALAH`                    BOOLEAN,
  `STONES_COUNT`                INT             NOT NULL,
   PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `PLAYER` (
  `ID`                          BIGINT          NOT NULL AUTO_INCREMENT,
  `VERSION`                     INT             NOT NULL DEFAULT 0,
  `LAST_UPDATED`                TIMESTAMP       NOT NULL,
  `KALAH_INDEX`                 INT,
  `NAME`                        VARCHAR,
   PRIMARY KEY (`ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `GAME_STATE_PLAYER_ENTITIES` (
  `GAME_STATE_ID`               BIGINT          NOT NULL,
  `PLAYER_ENTITIES_ID`          BIGINT          NOT NULL,
   PRIMARY KEY (`GAME_STATE_ID`, `PLAYER_ENTITIES_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

CREATE TABLE `GAME_BOARD_PITS` (
  `GAME_BOARD_ENTITY_ID`                 BIGINT          NOT NULL,
  `PITS_ID`                              BIGINT          NOT NULL,
   PRIMARY KEY (`GAME_BOARD_ENTITY_ID`, `PITS_ID`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8;

ALTER TABLE GAME_STATE ADD CONSTRAINT GAME_STATE_PLAYER_FK
   FOREIGN KEY (ACTIVE_PLAYER_ENTITY_ID) REFERENCES PLAYER;

ALTER TABLE GAME_STATE ADD CONSTRAINT GAME_STATE_GAME_BOARD_FK
   FOREIGN KEY (GAME_BOARD_ID) REFERENCES GAME_BOARD;

ALTER TABLE GAME_STATE_PLAYER_ENTITIES ADD CONSTRAINT GAME_STATE_PLAYER_ENTITIES_GAME_STATE_FK
   FOREIGN KEY (GAME_STATE_ID) REFERENCES AUTHORITY;

ALTER TABLE GAME_STATE_PLAYER_ENTITIES ADD CONSTRAINT GAME_STATE_PLAYER_ENTITIES_PLAYER_FK
   FOREIGN KEY (PLAYER_ENTITIES_ID) REFERENCES USER;

ALTER TABLE GAME_BOARD_PITS ADD CONSTRAINT GAME_BOARD_X_PIT_PIT_FK
   FOREIGN KEY (PITS_ID) REFERENCES PIT;

ALTER TABLE GAME_BOARD_PITS ADD CONSTRAINT GAME_BOARD_X_PIT_GAME_BOARD_FK
   FOREIGN KEY (GAME_BOARD_ENTITY_ID) REFERENCES GAME_BOARD;